<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TBM Bus Tracker</title>
<style>
body {
    margin:0;
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg,#4facfe,#00f2fe);
    color:white;
}
h1 { text-align:center; margin:15px; font-size:2rem;}
.container { padding:10px; }
.card {
    background: rgba(255,255,255,0.1);
    padding:15px;
    border-radius:12px;
    margin-bottom:10px;
    cursor:pointer;
    transform: translateY(20px);
    opacity:0;
    animation: slideFade 0.5s forwards;
}
@keyframes slideFade {
    to { transform: translateY(0); opacity:1; }
}
.card:hover { transform: scale(1.05); background: rgba(255,255,255,0.25);}
.back-btn {
    cursor:pointer;
    text-decoration: underline;
    display:inline-block;
    margin-bottom:10px;
}
.arrival-time {
    padding:12px;
    border-radius:10px;
    margin-top:5px;
    font-weight:bold;
    transition: all 0.5s;
}
</style>
</head>
<body>
<h1>TBM Bus Tracker</h1>
<div class="container" id="app"></div>

<script>
const ACCOUNT_KEY = "opendata-bordeaux-metropole-flux-gtfs-rt";
const BASE_SIRI = "https://bdx.mecatran.com/utw/ws/siri/2.0/bordeaux";
const BASE_VEHICLES = `https://bdx.mecatran.com/utw/ws/gtfsfeed/vehicles/bordeaux?apiKey=${ACCOUNT_KEY}`;
const app = document.getElementById('app');
let vehicleData = [];

// 1Ô∏è‚É£ R√©cup√©rer toutes les lignes
async function getLines() {
    const res = await fetch(`${BASE_SIRI}/lines-discovery.json?AccountKey=${ACCOUNT_KEY}`);
    const data = await res.json();
    return data.Siri.ServiceDelivery[0].LinesDelivery[0].Lines;
}

// 2Ô∏è‚É£ R√©cup√©rer tous les arr√™ts
async function getStops() {
    const res = await fetch(`${BASE_SIRI}/stoppoints-discovery.json?AccountKey=${ACCOUNT_KEY}`);
    const data = await res.json();
    return data.Siri.ServiceDelivery[0].StopPoints;
}

// 3Ô∏è‚É£ R√©cup√©rer tous les bus
async function getVehicles() {
    const res = await fetch(BASE_VEHICLES);
    const data = await res.json();
    vehicleData = data.Vehicles || [];
}

// 4Ô∏è‚É£ Afficher toutes les lignes
async function showLines(){
    app.innerHTML='';
    const lines = await getLines();
    lines.forEach((line,i)=>{
        const div = document.createElement('div');
        div.className='card';
        div.style.animationDelay=`${i*0.05}s`;
        div.textContent = `Ligne ${line.PublicCode} : ${line.Description}`;
        div.onclick = ()=>showLineStops(line.LineRef, line.PublicCode);
        app.appendChild(div);
    });
}

// 5Ô∏è‚É£ Afficher tous les arr√™ts d‚Äôune ligne
async function showLineStops(lineRef, lineCode){
    app.innerHTML=`<div class="back-btn" onclick="showLines()">‚Üê Retour</div><h2>Arr√™ts de la ligne ${lineCode}</h2>`;
    const stops = await getStops();
    let i=0;
    stops.forEach(stop=>{
        if(stop.Lines.includes(lineRef)){
            const div = document.createElement('div');
            div.className='card';
            div.style.animationDelay=`${i*0.05}s`;
            div.textContent = stop.Name;
            div.onclick = ()=>showStopDepartures(stop.StopPointRef, stop.Name, lineRef);
            app.appendChild(div);
            i++;
        }
    });
}

// 6Ô∏è‚É£ Afficher prochains passages + tous les bus pour cet arr√™t
async function showStopDepartures(stopId, stopName, lineRef){
    app.innerHTML=`<div class="back-btn" onclick="showLineStops('${lineRef}', '${lineRef}')">‚Üê Retour</div><h2>Arr√™t : ${stopName}</h2>`;
    
    // 6a. Prochains passages
    const res = await fetch(`${BASE_SIRI}/stop-monitoring.json?AccountKey=${ACCOUNT_KEY}&MonitoringRef=${stopId}`);
    const data = await res.json();
    const visits = data.Siri.ServiceDelivery[0].StopMonitoringDelivery[0].MonitoredStopVisit || [];
    if(visits.length===0){
        app.innerHTML+=`<p>Aucun d√©part pr√©vu pour l'instant.</p>`;
    }
    visits.forEach((v,i)=>{
        const journey = v.MonitoredVehicleJourney;
        const dir = journey.DirectionName || "Direction inconnue";
        const line = journey.LineRef || "";
        const aimedTime = new Date(journey.MonitoredCall.AimedDepartureTime);
        const now = new Date();
        const minutesLeft = Math.max(Math.round((aimedTime-now)/60000),0);
        const div = document.createElement('div');
        div.className='card arrival-time';
        div.style.animationDelay=`${i*0.05}s`;
        div.style.background = minutesLeft<=2 ? 'red' : minutesLeft<=5 ? 'orange' : 'green';
        div.textContent = `Ligne ${line} ‚Üí ${dir} ‚Üí dans ${minutesLeft} min`;
        app.appendChild(div);
    });

    // 6b. Tous les bus en temps r√©el
    await getVehicles();
    app.innerHTML+=`<h3 style="margin-top:20px;">Tous les bus en circulation :</h3>`;
    vehicleData.forEach((v,i)=>{
        const div = document.createElement('div');
        div.className='card arrival-time';
        div.style.animationDelay=`${i*0.02}s`;
        div.style.background = '#00ffff';
        div.textContent = `Bus ${v.VehicleRef} ‚Üí Ligne ${v.LineRef} ‚Üí ${v.DestinationName} ‚Üí Lat:${v.Latitude} Lon:${v.Longitude}`;
        app.appendChild(div);
    });
}

// üîÑ Mise √† jour auto des bus toutes les 15s
setInterval(async ()=>{
    const currentStop = document.querySelector('h2')?.textContent || '';
    if(currentStop.startsWith('Arr√™t')){
        const lineRef = currentStop.split('‚Üí')[0]?.trim() || '';
        showStopDepartures(vehicleData.StopPointRef, vehicleData.Name, lineRef);
    }
},15000);

// üöÄ D√©marrage
showLines();
</script>
</body>
</html>
