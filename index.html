<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Radio 24/7 — Lecteur synchronisé</title>
<style>
  :root{--bg:#0f1724;--muted:#9aa4b2;--accent:#7c3aed;color-scheme:dark}
  body{margin:0;font-family:sans-serif;background:#0f1724;color:white;display:flex;justify-content:center;padding:20px}
  .wrap{max-width:800px;width:100%}
  .player{display:flex;gap:16px;align-items:center;margin-top:20px}
  .art{width:140px;height:140px;border-radius:8px;background:#111;display:flex;align-items:center;justify-content:center;color:var(--muted);overflow:hidden}
  .meta{flex:1}
  .track{font-size:20px;font-weight:600}
  .artist{color:var(--muted);font-size:14px;margin-top:6px}
  .time{margin-top:8px;color:var(--muted);font-size:13px}
  .controls{margin-top:14px;display:flex;align-items:center;gap:10px}
  button{cursor:pointer;border:none;padding:10px 14px;border-radius:8px;font-weight:600}
  .primary{background:linear-gradient(90deg,var(--accent),#5b21b6);color:white}
  .ghost{background:transparent;border:1px solid rgba(255,255,255,0.1);color:var(--muted)}
  input[type=range]{accent-color:var(--accent)}
  .footer{margin-top:20px;font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <h1>Radio 24/7</h1>
  <div id="status">Chargement de la playlist…</div>

  <div class="player">
    <div class="art" id="art">—</div>
    <div class="meta">
      <div class="track" id="title">—</div>
      <div class="artist" id="artist">—</div>
      <div class="time" id="time">—</div>
      <div class="controls">
        <button id="listenBtn" class="primary">Écouter</button>
        <div style="flex:1"></div>
        <label style="font-size:12px">Volume</label>
        <input id="volume" type="range" min="0" max="1" step="0.01" value="0.8">
      </div>
    </div>
  </div>

  <div class="footer">
    Playlist chargée depuis <code>list.json</code> (chemins relatifs vers tes mp3).<br>
    Métadonnées récupérées via l’API iTunes.
  </div>
</div>

<script>
const CYCLE_EPOCH = Date.UTC(2025,0,1,0,0,0);
const itunesBase = 'https://itunes.apple.com/search?media=music&entity=song&limit=1&term=';

let playlist = []; // {url, fileName, duration, meta}
let order = [];
let masterAudio = new Audio();
let started = false;
let updateTimer=null;
let currentOrderIndex=0;

const statusEl=document.getElementById('status');
const titleEl=document.getElementById('title');
const artistEl=document.getElementById('artist');
const artEl=document.getElementById('art');
const timeEl=document.getElementById('time');
const listenBtn=document.getElementById('listenBtn');
const volumeEl=document.getElementById('volume');

volumeEl.addEventListener('input',()=>{masterAudio.volume=parseFloat(volumeEl.value)});
listenBtn.addEventListener('click',()=>{ if(!started) startPlayback(); });

function status(s){ statusEl.textContent=s; }
function getFileName(u){ return decodeURIComponent(u.split('/').pop().split('?')[0]); }

async function loadPlaylist(){
  try{
    const r=await fetch('list.json',{cache:'no-store'});
    const arr=await r.json();
    playlist=arr.map(u=>({url:u,fileName:getFileName(u),duration:0,meta:null}));
    await Promise.all(playlist.map(p=>loadDuration(p)));
    buildShuffle();
    await Promise.all(playlist.map(p=>fetchMetadata(p)));
    status('Prêt — clique "Écouter"');
  }catch(e){ status('Erreur chargement list.json: '+e); }
}

function loadDuration(p){
  return new Promise(res=>{
    const a=new Audio();
    a.preload='metadata'; a.src=p.url; a.onloadedmetadata=()=>{
      p.duration=isFinite(a.duration)?a.duration:180; res();
    };
    setTimeout(()=>{if(!p.duration)p.duration=180;res();},5000);
  });
}

function buildShuffle(){
  const n=playlist.length; if(!n)return;
  order=Array.from({length:n},(_,i)=>i);
  for(let i=n-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[order[i],order[j]]=[order[j],order[i]];}
  if(n>1 && order[0]===order[n-1]) [order[0],order[1]]=[order[1],order[0]];
}

async function fetchMetadata(p){
  let q=p.fileName.replace(/\.[^.]+$/,'').replace(/^\d+[-_.\s]*/,'');
  const url=itunesBase+encodeURIComponent(q);
  try{
    const r=await fetch(url); const j=await r.json();
    if(j.resultCount>0){
      const t=j.results[0];
      p.meta={artist:t.artistName,track:t.trackName,artwork:t.artworkUrl100.replace('100x100','600x600')};
      return;
    }
  }catch(e){}
  p.meta={artist:'',track:p.fileName,artwork:null};
}

function getTotalDuration(){return playlist.reduce((s,p)=>s+(p.duration||0),0)||1;}
function computePos(){
  let elapsed=(Date.now()-CYCLE_EPOCH)/1000;
  let t=elapsed%getTotalDuration();
  for(let i=0;i<order.length;i++){
    let d=playlist[order[i]].duration||1;
    if(t<d) return {orderIndex:i,time:t};
    t-=d;
  }
  return {orderIndex:0,time:0};
}

function playOrderIndex(idx,offset=0){
  currentOrderIndex=idx;
  const p=playlist[order[idx]];
  masterAudio.src=p.url;
  masterAudio.currentTime=offset;
  masterAudio.play().catch(()=>status('Clique "Écouter" pour lancer'));
  updateInfo();
}

function updateInfo(){
  const p=playlist[order[currentOrderIndex]];
  if(!p)return;
  titleEl.textContent=p.meta?p.meta.track:p.fileName;
  artistEl.textContent=p.meta?p.meta.artist:'';
  if(p.meta&&p.meta.artwork){artEl.style.backgroundImage=`url(${p.meta.artwork})`;artEl.textContent='';}
  else {artEl.style.backgroundImage='';artEl.textContent='—';}
  if(masterAudio.duration){
    let rem=masterAudio.duration-masterAudio.currentTime;
    timeEl.textContent=`${fmt(masterAudio.currentTime)} / ${fmt(masterAudio.duration)} — restant ${fmt(rem)}`;
  }
}

function fmt(s){if(!isFinite(s))return'—';const m=Math.floor(s/60);const sec=Math.floor(s%60).toString().padStart(2,'0');return`${m}:${sec}`;}

function startPlayback(){
  started=true;listenBtn.disabled=true;masterAudio.volume=parseFloat(volumeEl.value);
  const pos=computePos(); playOrderIndex(pos.orderIndex,pos.time);
  updateTimer=setInterval(()=>{updateInfo();
    if(masterAudio.duration&&masterAudio.currentTime+0.5>=masterAudio.duration){
      playOrderIndex((currentOrderIndex+1)%order.length,0);
    }},1000);
}

loadPlaylist();
</script>
</body>
</html>
