<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TBM Bus Tracker</title>
<!-- Leaflet CSS pour la carte -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body { margin:0; font-family:sans-serif; background: linear-gradient(to right,#4facfe,#00f2fe); color:white;}
h1 { text-align:center; margin:15px; }
.container { padding:10px; }
.card { background: rgba(255,255,255,0.1); padding:12px; border-radius:10px; margin-bottom:8px; cursor:pointer; transition:0.2s; }
.card:hover { transform: scale(1.03); background: rgba(255,255,255,0.2);}
.back-btn { cursor:pointer; text-decoration:underline; display:inline-block; margin-bottom:8px;}
.arrival-time { background: rgba(0,0,0,0.2); padding:10px; border-radius:8px; margin-top:5px; }
#map { height: 300px; margin-top:10px; border-radius:10px; }
</style>
</head>
<body>
<h1>TBM Bus Tracker</h1>
<div class="container" id="app"></div>
<div id="map"></div>

<!-- Leaflet JS pour la carte -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const ACCOUNT_KEY = "opendata-bordeaux-metropole-flux-gtfs-rt";
const BASE_SIRI = "https://bdx.mecatran.com/utw/ws/siri/2.0/bordeaux";
const BASE_VEHICLES = "https://bdx.mecatran.com/utw/ws/gtfsfeed/vehicles/bordeaux?apiKey="+ACCOUNT_KEY;
const app = document.getElementById('app');

// Initialisation de la carte
const map = L.map('map').setView([44.8378, -0.5792], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);
let vehicleMarkers = {};

// --- Fonctions principales ---

// 1Ô∏è‚É£ Toutes les lignes
async function getLines(){
    const res = await fetch(`${BASE_SIRI}/lines-discovery.json?AccountKey=${ACCOUNT_KEY}`);
    const data = await res.json();
    return data.Lines;
}

// 2Ô∏è‚É£ Tous les arr√™ts
async function getStops(){
    const res = await fetch(`${BASE_SIRI}/stoppoints-discovery.json?AccountKey=${ACCOUNT_KEY}`);
    const data = await res.json();
    return data.StopPoints;
}

// 3Ô∏è‚É£ Affiche lignes
async function showLines(){
    app.innerHTML = '';
    const lines = await getLines();
    lines.forEach(line=>{
        const div = document.createElement('div');
        div.className='card';
        div.textContent = `Ligne ${line.PublicCode} : ${line.Description}`;
        div.onclick = ()=>showLineStops(line.LineRef);
        app.appendChild(div);
    });
}

// 4Ô∏è‚É£ Affiche arr√™ts d‚Äôune ligne
async function showLineStops(lineRef){
    app.innerHTML=`<div class="back-btn" onclick="showLines()">‚Üê Retour</div><h2>Arr√™ts de la ligne</h2>`;
    const stops = await getStops();
    stops.forEach(stop=>{
        if(stop.Lines.includes(lineRef)){
            const div=document.createElement('div');
            div.className='card';
            div.textContent=stop.Name;
            div.onclick = ()=>showStopDepartures(stop.StopPointRef, stop.Name, stop.Latitude, stop.Longitude);
            app.appendChild(div);
        }
    });
}

// 5Ô∏è‚É£ Prochains passages pour un arr√™t + centrer carte
async function showStopDepartures(stopId, stopName, lat, lon){
    app.innerHTML=`<div class="back-btn" onclick="showLines()">‚Üê Retour</div><h2>Arr√™t : ${stopName}</h2>`;
    map.setView([lat, lon], 15);
    L.marker([lat, lon]).addTo(map).bindPopup(stopName).openPopup();

    const res = await fetch(`${BASE_SIRI}/stop-monitoring.json?AccountKey=${ACCOUNT_KEY}&MonitoringRef=${stopId}`);
    const data = await res.json();
    const visits = data.Siri.ServiceDelivery.StopMonitoringDelivery[0].MonitoredStopVisit;
    if(!visits || visits.length===0){
        app.innerHTML+=`<p>Aucun d√©part pr√©vu pour l'instant.</p>`;
        return;
    }
    visits.forEach(v=>{
        const journey = v.MonitoredVehicleJourney;
        const dir = journey.DirectionName || "Direction inconnue";
        const line = journey.LineRef || "";
        const aimedTime = new Date(journey.MonitoredCall.AimedDepartureTime);
        const now = new Date();
        const minutesLeft = Math.max(Math.round((aimedTime-now)/60000),0);
        const div=document.createElement('div');
        div.className='card arrival-time';
        div.textContent=`Ligne ${line} ‚Üí ${dir} ‚Üí dans ${minutesLeft} min`;
        app.appendChild(div);
    });
}

// 6Ô∏è‚É£ Mettre √† jour positions v√©hicules
async function updateVehicles(){
    const res = await fetch(BASE_VEHICLES);
    const data = await res.json();
    const vehicles = data.Vehicles;
    vehicles.forEach(v=>{
        const id = v.VehicleRef;
        const lat = parseFloat(v.Latitude);
        const lon = parseFloat(v.Longitude);
        const popup = `Ligne ${v.LineRef} ‚Üí ${v.DestinationName}`;
        if(vehicleMarkers[id]){
            vehicleMarkers[id].setLatLng([lat, lon]);
        } else {
            vehicleMarkers[id] = L.marker([lat, lon], {icon:L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/61/61231.png',iconSize:[30,30]})}).addTo(map).bindPopup(popup);
        }
    });
}
setInterval(updateVehicles, 10000); // mise √† jour toutes les 10s

// üöÄ D√©marrage
showLines();
updateVehicles();
</script>
</body>
</html>
