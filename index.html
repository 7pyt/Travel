<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TBM Bus Tracker Corrected</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
body {
    margin:0;
    font-family: 'Segoe UI', sans-serif;
    background: linear-gradient(135deg,#4facfe,#00f2fe);
    color:white;
}
h1 { text-align:center; margin:15px; font-size:2rem;}
.container { padding:10px; position:relative; z-index:10; }
.card {
    background: rgba(255,255,255,0.1);
    padding:15px;
    border-radius:12px;
    margin-bottom:10px;
    cursor:pointer;
    transform: translateY(20px);
    opacity:0;
    animation: slideFade 0.5s forwards;
}
@keyframes slideFade {
    to { transform: translateY(0); opacity:1; }
}
.card:hover { transform: scale(1.05); background: rgba(255,255,255,0.25);}
.back-btn {
    cursor:pointer;
    text-decoration: underline;
    display:inline-block;
    margin-bottom:10px;
}
.arrival-time {
    padding:12px;
    border-radius:10px;
    margin-top:5px;
    font-weight:bold;
    transition: all 0.5s;
}
#map { height:350px; margin-top:10px; border-radius:10px; box-shadow: 0 0 20px rgba(0,0,0,0.5); position:relative; z-index:0;}
</style>
</head>
<body>
<h1>TBM Bus Tracker Ultra</h1>
<div class="container" id="app"></div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const ACCOUNT_KEY = "opendata-bordeaux-metropole-flux-gtfs-rt";
const BASE_SIRI = "https://bdx.mecatran.com/utw/ws/siri/2.0/bordeaux";
const BASE_VEHICLES = `https://bdx.mecatran.com/utw/ws/gtfsfeed/vehicles/bordeaux?apiKey=${ACCOUNT_KEY}`;
const app = document.getElementById('app');

// Carte Leaflet
const map = L.map('map').setView([44.8378, -0.5792], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
    attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);
let vehicleMarkers = {};

// --- Fonctions principales ---

// 1Ô∏è‚É£ R√©cup√©rer toutes les lignes
async function getLines() {
    const res = await fetch(`${BASE_SIRI}/lines-discovery.json?AccountKey=${ACCOUNT_KEY}`);
    const data = await res.json();
    return data.Siri.ServiceDelivery[0].LinesDelivery[0].Lines;
}

// 2Ô∏è‚É£ R√©cup√©rer tous les arr√™ts
async function getStops() {
    const res = await fetch(`${BASE_SIRI}/stoppoints-discovery.json?AccountKey=${ACCOUNT_KEY}`);
    const data = await res.json();
    return data.Siri.ServiceDelivery[0].StopPoints;
}

// 3Ô∏è‚É£ Afficher toutes les lignes
async function showLines(){
    app.innerHTML='';
    const lines = await getLines();
    lines.forEach((line,i)=>{
        const div = document.createElement('div');
        div.className='card';
        div.style.animationDelay=`${i*0.05}s`;
        div.textContent = `Ligne ${line.PublicCode} : ${line.Description}`;
        div.onclick = ()=>showLineStops(line.LineRef);
        app.appendChild(div);
    });
}

// 4Ô∏è‚É£ Afficher tous les arr√™ts d‚Äôune ligne
async function showLineStops(lineRef){
    app.innerHTML=`<div class="back-btn" onclick="showLines()">‚Üê Retour</div><h2>Arr√™ts de la ligne</h2>`;
    const stops = await getStops();
    let i=0;
    stops.forEach(stop=>{
        if(stop.Lines.includes(lineRef)){
            const div = document.createElement('div');
            div.className='card';
            div.style.animationDelay=`${i*0.05}s`;
            div.textContent = stop.Name;
            div.onclick = ()=>showStopDepartures(stop.StopPointRef, stop.Name, stop.Latitude, stop.Longitude);
            app.appendChild(div);
            i++;
        }
    });
}

// 5Ô∏è‚É£ Afficher les prochains passages d‚Äôun arr√™t + centrer sur la carte
async function showStopDepartures(stopId, stopName, lat, lon){
    app.innerHTML=`<div class="back-btn" onclick="showLines()">‚Üê Retour</div><h2>Arr√™t : ${stopName}</h2>`;
    map.setView([lat, lon], 15);
    L.marker([lat, lon]).addTo(map).bindPopup(stopName).openPopup();

    const res = await fetch(`${BASE_SIRI}/stop-monitoring.json?AccountKey=${ACCOUNT_KEY}&MonitoringRef=${stopId}`);
    const data = await res.json();
    const deliveries = data.Siri.ServiceDelivery[0].StopMonitoringDelivery[0].MonitoredStopVisit || [];
    if(deliveries.length===0){ app.innerHTML+=`<p>Aucun d√©part pr√©vu.</p>`; return; }

    deliveries.forEach((v,i)=>{
        const journey=v.MonitoredVehicleJourney;
        const dir = journey.DirectionName || "Direction inconnue";
        const line = journey.LineRef || "";
        const aimedTime = new Date(journey.MonitoredCall.AimedDepartureTime);
        const now = new Date();
        const minutesLeft = Math.max(Math.round((aimedTime-now)/60000),0);
        const div = document.createElement('div');
        div.className='card arrival-time';
        div.style.animationDelay=`${i*0.05}s`;
        div.style.background = minutesLeft<=2 ? 'red' : minutesLeft<=5 ? 'orange' : 'green';
        div.textContent = `Ligne ${line} ‚Üí ${dir} ‚Üí dans ${minutesLeft} min`;
        app.appendChild(div);
    });
}

// 6Ô∏è‚É£ Mettre √† jour positions des bus en temps r√©el
async function updateVehicles(){
    const res = await fetch(BASE_VEHICLES);
    const data = await res.json();
    const vehicles = data.Vehicles || [];
    vehicles.forEach(v=>{
        const id = v.VehicleRef;
        const lat = parseFloat(v.Latitude);
        const lon = parseFloat(v.Longitude);
        const popup = `Ligne ${v.LineRef} ‚Üí ${v.DestinationName}`;
        if(vehicleMarkers[id]){
            vehicleMarkers[id].setLatLng([lat, lon]);
        } else {
            vehicleMarkers[id]=L.marker([lat,lon],{
                icon:L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/61/61231.png',iconSize:[30,30]})
            }).addTo(map).bindPopup(popup);
        }
    });
}
setInterval(updateVehicles,10000);

// üöÄ Lancement
showLines();
updateVehicles();
</script>
</body>
</html>
