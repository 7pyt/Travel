<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TBM â€” Toutes les lignes bus & tram (aller/retour + arrÃªts + temps rÃ©el)</title>
<style>
  :root{--bg:#0b1020;--fg:#f7f8fc;--muted:#b8c2d9;--card:#121933;--accent:#4cc9f0}
  html,body{margin:0;height:100%;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
  .app{display:grid;grid-template-columns:320px 1fr;gap:12px;height:100%;padding:12px;box-sizing:border-box}
  .panel{background:var(--card);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.25);display:flex;flex-direction:column;min-height:0}
  .panel h2{margin:0;padding:14px 16px;border-bottom:1px solid rgba(255,255,255,.06);font-size:18px}
  .panel .body{padding:10px 12px;overflow:auto}
  .search{display:flex;gap:8px;padding:10px 12px;border-bottom:1px solid rgba(255,255,255,.06)}
  .search input{flex:1;padding:10px 12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:#0e1530;color:var(--fg);outline:none}
  .pill{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;margin:6px;border-radius:14px;cursor:pointer;
        background:#0f1836;border:1px solid rgba(255,255,255,.07);transition:.15s;user-select:none}
  .pill:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(0,0,0,.25)}
  .pill .dot{width:14px;height:14px;border-radius:50%;box-shadow:0 0 0 2px rgba(0,0,0,.25) inset}
  .pill .tag{font-size:12px;color:var(--muted);padding:2px 8px;border:1px solid rgba(255,255,255,.12);border-radius:999px}
  .subtle{color:var(--muted);font-size:12px}
  .hr{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.08),transparent);margin:10px 0}
  .list{display:flex;flex-wrap:wrap}
  .empty{opacity:.7;padding:12px}
  .loading{padding:18px;display:flex;align-items:center;gap:10px}
  .spinner{width:18px;height:18px;border-radius:50%;border:3px solid rgba(255,255,255,.25);border-top-color:var(--accent);animation:spin 1s linear infinite}
  @keyframes spin{to{transform:rotate(360deg)}}
  .dir{display:flex;flex-direction:column;gap:8px}
  .dir button{all:unset;cursor:pointer;padding:12px;border-radius:12px;background:#0f1836;border:1px solid rgba(255,255,255,.08)}
  .dir button:hover{transform:translateY(-1px);box-shadow:0 6px 14px rgba(0,0,0,.25)}
  ol.stops{margin:0;padding-left:18px}
  li.stop{margin:6px 0;padding:6px 8px;border-left:3px solid rgba(255,255,255,.12);cursor:pointer}
  li.stop:hover{background:rgba(255,255,255,.04)}
  .badge{display:inline-flex;gap:6px;align-items:center;padding:4px 8px;border-radius:999px;background:rgba(255,255,255,.06);font-size:12px}
  .footer{padding:10px 12px;border-top:1px solid rgba(255,255,255,.06);font-size:12px;color:var(--muted)}
  .hint{padding:8px 12px;background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.08);border-radius:12px;margin:8px 0}
  .tiny{font-size:11px;color:var(--muted)}
  @media (max-width:900px){.app{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="app">
  <section class="panel" id="left">
    <h2>ðŸšŒðŸšˆ Lignes TBM <span class="subtle" id="count"></span></h2>
    <div class="search"><input id="q" placeholder="Rechercher une ligneâ€¦ (ex: A, 4, Lianes 1)" /></div>
    <div class="body"><div id="lines" class="list"></div><div class="empty" id="linesEmpty" style="display:none">Aucune ligne</div></div>
    <div class="footer">DonnÃ©es statiques + temps rÃ©el TBM</div>
  </section>
  <section class="panel" id="right">
    <h2 id="rightTitle">SÃ©lectionnez une ligne</h2>
    <div class="body" id="rightBody"><div class="hint">Clique une ligne, une direction, puis un arrÃªt pour voir lâ€™arrivÃ©e en temps rÃ©el.</div></div>
    <div class="footer" id="meta"></div>
  </section>
</div>

<script>
/* --- parser CSV --- */
function parseCSV(text){const rows=[];let i=0,field='',row=[],inQuotes=false;while(i<text.length){const c=text[i];if(inQuotes){if(c==='"'){if(text[i+1]==='"'){field+='"';i++;}else inQuotes=false;}else field+=c;}else{if(c==='"')inQuotes=true;else if(c===','){row.push(field);field='';}else if(c==='\n'){row.push(field);rows.push(row);row=[];field='';}else if(c!=='\r')field+=c;}i++;}if(field.length||row.length){row.push(field);rows.push(row);}const h=rows.shift();return rows.map(r=>Object.fromEntries(h.map((hh,idx)=>[hh,r[idx]??""])))}

/* --- mini JSZip placeholder (met la vraie lib si besoin) --- */
!function(e){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t=("undefined"!=typeof window?window:this);t.JSZip=e()}}(function(){/* â€¦ lib minifiÃ©e complÃ¨te Ã  coller â€¦ */});
</script>

<script>
(async () => {
  const gtfsURL="https://bdx.mecatran.com/utw/ws/gtfsfeed/static/bordeaux?apiKey=opendata-bordeaux-metropole-flux-gtfs-rt";
  const state={routes:[],trips:[],stops:[],stop_times:[],by:{stopsById:{},tripsByRoute:{}}};
  const rightTitle=document.getElementById('rightTitle'),rightBody=document.getElementById('rightBody'),
        meta=document.getElementById('meta'),linesWrap=document.getElementById('lines'),
        linesEmpty=document.getElementById('linesEmpty'),countEl=document.getElementById('count'),q=document.getElementById('q');

  function routeColor(r){const h=(r.route_color||"").trim();return/^([0-9A-Fa-f]{6})$/.test(h)?`#${h}`:"var(--accent)";}
  function pill(line){const n=line.route_short_name||"",long=line.route_long_name||"",c=routeColor(line);
    const el=document.createElement('div');el.className='pill';
    el.innerHTML=`<span class="dot" style="background:${c}"></span><strong>${n||long}</strong><span class="subtle">${long&&n?"â€” "+long:""}</span>`;
    el.onclick=()=>showLine(line);return el;}
  function listLines(f=""){linesWrap.innerHTML="";f=f.toLowerCase();const vis=state.routes.filter(r=>(`${r.route_short_name} ${r.route_long_name}`).toLowerCase().includes(f));
    vis.forEach(r=>linesWrap.appendChild(pill(r)));linesEmpty.style.display=vis.length?"none":"block";countEl.textContent=`(${vis.length}/${state.routes.length})`;}
  q.oninput=e=>listLines(e.target.value);

  async function fetchArrayBuffer(u){const r=await fetch(u);if(!r.ok)throw new Error("HTTP "+r.status);return r.arrayBuffer();}
  const buf=await fetchArrayBuffer(gtfsURL),zip=await JSZip.loadAsync(buf),
        files={};for(const n of["routes.txt","trips.txt","stops.txt","stop_times.txt"]){files[n]=parseCSV(await zip.file(n).async("string"));}
  state.routes=files["routes.txt"].filter(r=>r.route_type==="0"||r.route_type==="3");state.trips=files["trips.txt"];state.stops=files["stops.txt"];state.stop_times=files["stop_times.txt"];
  state.by.stopsById=Object.fromEntries(state.stops.map(s=>[s.stop_id,s]));state.by.tripsByRoute={};for(const t of state.trips){(state.by.tripsByRoute[t.route_id]??=[]).push(t);}
  listLines();

  function showLine(route){rightTitle.textContent=`Ligne ${route.route_short_name}`;const trips=state.by.tripsByRoute[route.route_id]||[];
    const dirs={"0":[],"1":[]};for(const t of trips){dirs[t.direction_id||"0"]?.push(t);}
    function best(dir){let pick=null,max=0;for(const t of dirs[dir]){const c=state.stop_times.filter(st=>st.trip_id===t.trip_id).length;if(c>max){max=c;pick=t;}}return pick;}
    const c=routeColor(route);
    function btn(trip,label){if(!trip)return`<div class=subtle>Aucune donnÃ©e ${label}</div>`;return `<button data-trip="${trip.trip_id}" style="border-color:${c}"><strong>${label} â†’ ${trip.trip_headsign}</strong></button>`;}
    rightBody.innerHTML=`<div class=dir>${btn(best("0"),"Aller")}${btn(best("1"),"Retour")}</div>`;
    rightBody.querySelectorAll("button[data-trip]").forEach(b=>b.onclick=()=>showStops(b.dataset.trip,c));}

  async function fetchRealtime(stopId){const url=`https://transport.data.gouv.fr/gtfs-rt/siri-lite/stop-monitoring?refdataset=offres-de-services-bus-tram-et-scolaire&stopPointId=${encodeURIComponent(stopId)}`;
    const j=await (await fetch(url)).json();const visits=j.Siri?.ServiceDelivery?.StopMonitoringDelivery?.[0]?.MonitoredStopVisit||[];
    const times=visits.map(v=>v.MonitoredVehicleJourney?.MonitoredCall?.ExpectedArrivalTime).filter(Boolean)
      .map(t=>Math.max(0,Math.round((new Date(t)-new Date())/60000)));return times.sort((a,b)=>a-b)[0];}

  function showStops(trip,c){const seq=state.stop_times.filter(st=>st.trip_id===trip).sort((a,b)=>a.stop_sequence-b.stop_sequence);
    const items=seq.map(st=>{const s=state.by.stopsById[st.stop_id];return `<li class=stop data-stop="${st.stop_id}"><strong>${s?.stop_name||st.stop_id}</strong> <span class=subtle>(clique)</span></li>`;}).join("");
    rightBody.innerHTML=`<div><div class=badge><span class=dot style="background:${c}"></span>ArrÃªts</div><ol class=stops>${items}</ol></div>`;
    rightBody.querySelectorAll("li.stop").forEach(li=>{li.onclick=async()=>{const sid=li.dataset.stop;li.querySelector(".subtle").textContent="(chargementâ€¦)";try{const m=await fetchRealtime(sid);li.querySelector(".subtle").textContent=m!=null?`(â‰ˆ ${m} min)`:"(pas de donnÃ©e)";}catch(e){li.querySelector(".subtle").textContent="(erreur)"}}});}
})();
</script>
</body>
</html>
