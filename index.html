<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Station Rap FR - YouTube Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">

  <!-- Header -->
  <header class="p-4 flex justify-between items-center bg-gray-800">
    <h1 class="text-xl font-bold">Station Rap FR — Tendances 24/7</h1>
    <div class="space-x-2">
      <button id="btn-home" class="px-3 py-1 rounded bg-gray-700 hover:bg-gray-600">Écouter</button>
      <button id="btn-admin" class="px-3 py-1 rounded bg-indigo-600 hover:bg-indigo-500">Admin</button>
    </div>
  </header>

  <!-- Home Page -->
  <main id="page-home" class="flex-1 p-6 hidden flex flex-col items-center justify-center">
    <div id="start-container" class="flex flex-col items-center gap-4">
      <button id="btn-start" class="px-6 py-3 bg-green-600 rounded text-lg font-bold hover:bg-green-500">
        Écouter
      </button>
      <div id="track-info" class="hidden text-center">
        <h2 id="track-title" class="text-xl font-semibold"></h2>
        <p id="time-left" class="mt-2 text-gray-300">0:00 / 0:00</p>
      </div>
    </div>
    <div id="player-container" class="mt-4">
      <div id="player"></div>
    </div>
  </main>

  <!-- Admin Page -->
  <main id="page-admin" class="flex-1 p-6 hidden">
    <div class="bg-gray-800 p-6 rounded max-w-2xl mx-auto">
      <button id="btn-back" class="mb-4 px-3 py-1 rounded bg-gray-700">Retour</button>
      <div id="admin-login">
        <h3 class="text-lg font-semibold mb-2">Connexion Admin</h3>
        <input id="admin-code" type="password" placeholder="Code admin"
          class="w-full p-2 rounded bg-gray-900 border border-gray-700 mb-2"/>
        <button id="btn-login" class="px-4 py-2 rounded bg-indigo-600">Se connecter</button>
        <div id="login-status" class="mt-2 text-sm text-yellow-300"></div>
      </div>
      <div id="admin-panel" class="hidden">
        <h3 class="text-lg font-semibold mb-3">Panneau Admin</h3>
        <div class="mb-4">
          <label class="block text-gray-400">Diffuser maintenant (URL YouTube)</label>
          <input id="yt-url" type="text" placeholder="https://www.youtube.com/watch?v=..." 
            class="w-full p-2 rounded bg-gray-900 border border-gray-700 mb-2"/>
          <button id="btn-play-now" class="px-4 py-2 rounded bg-green-600">Diffuser maintenant</button>
        </div>
        <div class="mb-4">
          <h4 class="font-semibold text-gray-300">Playlist actuelle</h4>
          <ul id="playlist" class="mt-2 space-y-1 max-h-64 overflow-auto"></ul>
        </div>
      </div>
    </div>
  </main>

  <footer class="p-4 text-sm text-gray-500 text-center">
    Démo - La lecture YouTube nécessite interaction utilisateur.
  </footer>

<script>
  // -----------------------------
  // CONFIG
  // -----------------------------
  const ADMIN_CODE = "MONSUPERSECRET";

  const btnHome = document.getElementById("btn-home");
  const btnAdmin = document.getElementById("btn-admin");
  const btnBack = document.getElementById("btn-back");
  const pageHome = document.getElementById("page-home");
  const pageAdmin = document.getElementById("page-admin");

  const adminLogin = document.getElementById("admin-login");
  const adminPanel = document.getElementById("admin-panel");
  const adminInput = document.getElementById("admin-code");
  const btnLogin = document.getElementById("btn-login");
  const loginStatus = document.getElementById("login-status");

  const ytUrlInput = document.getElementById("yt-url");
  const btnPlayNow = document.getElementById("btn-play-now");
  const playlistEl = document.getElementById("playlist");

  const btnStart = document.getElementById("btn-start");
  const trackInfo = document.getElementById("track-info");
  const trackTitle = document.getElementById("track-title");
  const timeLeftEl = document.getElementById("time-left");

  // -----------------------------
  // Routing
  // -----------------------------
  btnHome.onclick = () => { pageHome.classList.remove("hidden"); pageAdmin.classList.add("hidden"); }
  btnAdmin.onclick = () => { pageAdmin.classList.remove("hidden"); pageHome.classList.add("hidden"); }
  btnBack.onclick = () => { pageHome.classList.remove("hidden"); pageAdmin.classList.add("hidden"); }

  // -----------------------------
  // Player State
  // -----------------------------
  let player;
  let playlist = [
    "https://www.youtube.com/watch?v=ScMzIvxBSi4",
    "https://www.youtube.com/watch?v=J---aiyznGQ",
    "https://www.youtube.com/watch?v=oHg5SJYRHA0"
  ];
  let currentIndex = 0;
  let adminOverride = null;

  function shuffleArray(array){
    let arr=array.slice();
    for(let i=arr.length-1;i>0;i--){
      const j=Math.floor(Math.random()*(i+1));
      [arr[i],arr[j]]=[arr[j],arr[i]];
    }
    return arr;
  }

  function getVideoId(url){
    const reg=/[?&]v=([^&]+)/;
    const match=url.match(reg);
    return match ? match[1] : url;
  }

  function onYouTubeIframeAPIReady() {
    player = new YT.Player('player', {
      height:'360', width:'640',
      videoId:getVideoId(playlist[currentIndex]),
      events:{
        'onReady':()=>{},
        'onStateChange':onPlayerStateChange
      },
      playerVars:{autoplay:0, controls:0}
    });
  }

  function onPlayerStateChange(event){
    if(event.data === YT.PlayerState.ENDED){
      if(adminOverride){
        adminOverride=null;
        playNext();
      } else {
        playNext();
      }
    }
  }

  function playNext(){
    const shuffled = shuffleArray(playlist);
    currentIndex = Math.floor(Math.random()*shuffled.length);
    player.loadVideoById(getVideoId(shuffled[currentIndex]));
    trackTitle.textContent = `Lecture : ${shuffled[currentIndex]}`;
    trackInfo.classList.remove("hidden");
  }

  // -----------------------------
  // Start Button
  // -----------------------------
  btnStart.onclick = () => {
    playNext();
    btnStart.style.display="none";
    trackInfo.classList.remove("hidden");
  }

  // -----------------------------
  // Track timer update
  // -----------------------------
  setInterval(()=>{
    if(player && player.getCurrentTime && player.getDuration){
      const t = Math.floor(player.getCurrentTime()||0);
      const d = Math.floor(player.getDuration()||0);
      timeLeftEl.textContent = `${t}:${(d-t).toString().padStart(2,"0")} / ${d}:00`;
    }
  },500);

  // -----------------------------
  // Admin Login
  // -----------------------------
  btnLogin.onclick = () => {
    if(adminInput.value === ADMIN_CODE){
      adminLogin.classList.add("hidden");
      adminPanel.classList.remove("hidden");
      loginStatus.textContent="";
      renderPlaylist();
    } else {
      loginStatus.textContent="Code incorrect";
    }
  }

  btnPlayNow.onclick = () => {
    const url = ytUrlInput.value.trim();
    if(!url) return;
    adminOverride=url;
    player.loadVideoById(getVideoId(url));
    trackTitle.textContent = `Diffusion Admin : ${url}`;
  }

  function renderPlaylist(){
    playlistEl.innerHTML="";
    playlist.forEach((u,i)=>{
      const li=document.createElement("li");
      li.className="flex justify-between items-center bg-gray-700 p-2 rounded";
      li.innerHTML=`<span>${u}</span> <button class="px-2 py-1 bg-green-600 rounded">Diffuser</button>`;
      li.querySelector("button").onclick=()=>{
        adminOverride=u;
        player.loadVideoById(getVideoId(u));
        trackTitle.textContent = `Diffusion Admin : ${u}`;
      };
      playlistEl.appendChild(li);
    });
  }

</script>
</body>
</html>
