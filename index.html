import React, { useEffect, useRef, useState } from "react";

// StationRapFR - Single file React app
// - Page publique: joue en continu une playlist (auto-play next) venant d'une API (configurable)
// - N'affiche que des musiques rap françaises (filtrage côté client en exemple)
// - L'utilisateur ne peut que baisser/monter le son (volume local), pas skip/pause
// - Affiche titre, image, et barre de temps restant
// - Page admin accessible via /admin.html (route client-side) : login par code admin simple
// IMPORTANT : ceci est une implémentation front-end de démonstration. Pour une solution robuste
// et conforme au droit d'auteur vous devez ajouter un backend (auth, streaming sécurisé, CORS, licence)

// -----------------------------
// CONFIGURATION
// -----------------------------
const CONFIG = {
  // Endpoint d'exemple. Remplacez par votre vrai endpoint qui renvoie une liste d'objets piste:
  // [{ id, title, artist, image, audioUrl, genre, country, trendingScore }]
  MUSIC_API: "https://api.example.com/trending-music?limit=50",

  // Code admin simple (pour demo). Remplacez et utilisez un backend pour une vraie authentification.
  ADMIN_CODE: "MONSUPERSECRET",

  // Si vous voulez forcer l'autoplay au chargement (attention aux politiques navigateur) :
  START_AUTOPLAY: true,
};

// -----------------------------
// Utilitaires
// -----------------------------
function formatTime(seconds) {
  if (!isFinite(seconds)) return "0:00";
  const m = Math.floor(seconds / 60);
  const s = Math.floor(seconds % 60);
  return `${m}:${s.toString().padStart(2, "0")}`;
}

// -----------------------------
// App
// -----------------------------
export default function StationRapFR() {
  const [tracks, setTracks] = useState([]); // playlist
  const [index, setIndex] = useState(0);
  const [isAdmin, setIsAdmin] = useState(false);
  const [route, setRoute] = useState(
    window.location.pathname.endsWith("/admin.html") || window.location.pathname.endsWith("admin.html")
      ? "/admin"
      : "/"
  );

  useEffect(() => {
    // simple routing - update when manually navigate
    const onPop = () => {
      setRoute(window.location.pathname === "/admin.html" || window.location.pathname === "/admin" ? "/admin" : "/");
    };
    window.addEventListener("popstate", onPop);
    return () => window.removeEventListener("popstate", onPop);
  }, []);

  useEffect(() => {
    // if admin code was previously provided in sessionStorage
    const ok = sessionStorage.getItem("station_admin_ok");
    if (ok === "1") setIsAdmin(true);
  }, []);

  useEffect(() => {
    // fetch tracks once
    async function load() {
      try {
        const res = await fetch(CONFIG.MUSIC_API);
        if (!res.ok) throw new Error("Erreur API");
        const data = await res.json();
        // filtrer: rap français et tendances (exemple côté client). Idéal : côté serveur.
        const filtered = (data || [])
          .filter((t) => {
            const genre = (t.genre || "").toLowerCase();
            const country = (t.country || "").toLowerCase();
            const trending = t.trendingScore || 0;
            return genre.includes("rap") && (country === "fr" || country === "france") && trending > 0;
          })
          .sort((a, b) => (b.trendingScore || 0) - (a.trendingScore || 0));

        setTracks(filtered);
      } catch (e) {
        console.error("Impossible de charger les musiques:", e);
      }
    }
    load();
  }, []);

  // small helper to navigate
  function gotoAdmin() {
    window.history.pushState({}, "admin", "/admin.html");
    setRoute("/admin");
  }
  function gotoHome() {
    window.history.pushState({}, "home", "/");
    setRoute("/");
  }

  return (
    <div className="min-h-screen bg-gray-900 text-white p-4 font-sans">
      <header className="max-w-4xl mx-auto flex items-center justify-between py-4">
        <h1 className="text-2xl font-bold">Station Rap FR — Tendances 24/7</h1>
        <div className="space-x-2">
          <button
            onClick={gotoHome}
            className="px-3 py-1 rounded bg-gray-800 hover:bg-gray-700"
          >
            Écouter
          </button>
          <button
            onClick={gotoAdmin}
            className="px-3 py-1 rounded bg-indigo-600 hover:bg-indigo-500"
          >
            Admin
          </button>
        </div>
      </header>

      <main className="max-w-4xl mx-auto mt-6">
        {route === "/" && (
          <Player
            tracks={tracks}
            index={index}
            setIndex={setIndex}
            startAutoplay={CONFIG.START_AUTOPLAY}
          />
        )}

        {route === "/admin" && (
          <Admin
            isAdmin={isAdmin}
            setIsAdmin={setIsAdmin}
            onBack={gotoHome}
            tracks={tracks}
            refreshTracks={() => window.location.reload()}
          />
        )}

        <footer className="mt-8 text-sm text-gray-400">
          <p>
            Démo — Remplacez <code>CONFIG.MUSIC_API</code> par votre API, et ajoutez un backend pour
            l'authentification et la gestion des streams (obligatoire pour la production et la
            conformité aux licences).
          </p>
        </footer>
      </main>
    </div>
  );
}

// -----------------------------
// Player component
// -----------------------------
function Player({ tracks, index, setIndex, startAutoplay }) {
  const audioRef = useRef(null);
  const [volume, setVolume] = useState(1);
  const [timeLeft, setTimeLeft] = useState(0);
  const [duration, setDuration] = useState(0);
  const [playing, setPlaying] = useState(false);

  useEffect(() => {
    if (!audioRef.current) return;
    audioRef.current.volume = volume;
  }, [volume]);

  useEffect(() => {
    if (!audioRef.current) return;
    const a = audioRef.current;

    function onTime() {
      setDuration(a.duration || 0);
      setTimeLeft(Math.max(0, (a.duration || 0) - a.currentTime));
    }
    function onEnded() {
      // auto-advance to next track
      setPlaying(false);
      setTimeout(() => {
        setIndex((i) => (i + 1) % Math.max(1, tracks.length));
      }, 300);
    }
    function onPlay() {
      setPlaying(true);
    }
    function onPause() {
      setPlaying(false);
    }

    a.addEventListener("timeupdate", onTime);
    a.addEventListener("ended", onEnded);
    a.addEventListener("play", onPlay);
    a.addEventListener("pause", onPause);

    return () => {
      a.removeEventListener("timeupdate", onTime);
      a.removeEventListener("ended", onEnded);
      a.removeEventListener("play", onPlay);
      a.removeEventListener("pause", onPause);
    };
  }, [tracks, setIndex]);

  // When track index changes, load and optionally autoplay
  useEffect(() => {
    const a = audioRef.current;
    if (!a) return;
    if (!tracks || tracks.length === 0) return;
    const t = tracks[index % tracks.length];
    if (!t) return;
    a.src = t.audioUrl;
    a.load();
    // essayer de démarrer (les navigateurs peuvent bloquer autoplay sans interaction)
    if (startAutoplay) {
      a.play().catch(() => {
        // autoplay bloqué -> on attend que l'utilisateur interagisse (ici: on ne propose aucun control autre que volume)
      });
    }
  }, [index, tracks, startAutoplay]);

  const current = tracks && tracks.length > 0 ? tracks[index % tracks.length] : null;

  return (
    <div className="bg-gray-800 rounded p-6 flex gap-6 items-center">
      <div className="w-40 h-40 flex-shrink-0 rounded overflow-hidden bg-black">
        {current ? (
          <img src={current.image} alt={current.title} className="w-full h-full object-cover" />
        ) : (
          <div className="w-full h-full flex items-center justify-center text-gray-500">No cover</div>
        )}
      </div>

      <div className="flex-1">
        <h2 className="text-xl font-semibold">{current ? current.title : "En attente..."}</h2>
        <p className="text-gray-300">{current ? (current.artist || "Artiste inconnu") : ""}</p>

        <div className="mt-4">
          <ProgressBar duration={duration} timeLeft={timeLeft} />
        </div>

        <div className="mt-4 flex items-center gap-4">
          <div>
            <label className="block text-sm text-gray-400">Volume (local)</label>
            <input
              aria-label="volume"
              type="range"
              min={0}
              max={1}
              step={0.01}
              value={volume}
              onChange={(e) => setVolume(parseFloat(e.target.value))}
            />
          </div>

          <div className="ml-auto text-right text-sm text-gray-300">
            <div>Temps restant</div>
            <div className="font-mono">{formatTime(Math.round(timeLeft || 0))}</div>
          </div>
        </div>
      </div>

      <audio ref={audioRef} />
    </div>
  );
}

function ProgressBar({ duration, timeLeft }) {
  const played = duration ? Math.max(0, Math.min(1, (duration - timeLeft) / duration)) : 0;
  const remaining = Math.ceil(timeLeft || 0);
  return (
    <div>
      <div className="w-full bg-gray-700 h-3 rounded overflow-hidden">
        <div className="h-full rounded" style={{ width: `${played * 100}%`, background: "linear-gradient(90deg, rgba(99,102,241,1), rgba(59,130,246,1))" }} />
      </div>
      <div className="flex justify-between text-xs text-gray-400 mt-1">
        <span>{formatTime(Math.round(duration - (duration * played) || 0))}</span>
        <span>-{formatTime(remaining)}</span>
      </div>
    </div>
  );
}

// -----------------------------
// Admin component
// -----------------------------
function Admin({ isAdmin, setIsAdmin, onBack, tracks, refreshTracks }) {
  const [code, setCode] = useState("");
  const [search, setSearch] = useState("");
  const [results, setResults] = useState([]);
  const [status, setStatus] = useState("");

  async function checkCode(e) {
    e.preventDefault();
    // Demo check côté client. Pour vrai usage, vérifier côté serveur.
    if (code === CONFIG.ADMIN_CODE) {
      sessionStorage.setItem("station_admin_ok", "1");
      setIsAdmin(true);
      setStatus("Authentification réussie");
    } else {
      setStatus("Code incorrect");
    }
  }

  async function searchAPI(q) {
    if (!q) return setResults([]);
    try {
      // Exemple: endpoint de recherche. Remplacez par votre API.
      const res = await fetch(CONFIG.MUSIC_API + "&q=" + encodeURIComponent(q));
      const data = await res.json();
      setResults((data || []).slice(0, 30));
    } catch (e) {
      console.error(e);
      setResults([]);
    }
  }

  async function pickTrack(track) {
    // Dans une vraie app, vous enverriez une requête au backend pour forcer la lecture sur la station.
    // Ici on va stocker dans localStorage pour démonstration (le lecteur peut alors lire ce choix si il poll)
    localStorage.setItem("station_force_play", JSON.stringify(track));
    setStatus(`Piste "${track.title}" choisie. Recharger la page publique pour appliquer.`);
  }

  return (
    <div className="bg-gray-800 rounded p-6">
      <button onClick={onBack} className="mb-4 px-3 py-1 rounded bg-gray-700">Retour</button>

      {!isAdmin && (
        <form onSubmit={checkCode} className="max-w-md">
          <h3 className="text-lg font-semibold mb-2">Connexion Admin</h3>
          <input
            type="password"
            placeholder="Entrez le code admin"
            value={code}
            onChange={(e) => setCode(e.target.value)}
            className="w-full p-2 rounded bg-gray-900 border border-gray-700 mb-2"
          />
          <button className="px-4 py-2 rounded bg-indigo-600">Se connecter</button>
          <div className="mt-2 text-sm text-yellow-300">{status}</div>
        </form>
      )}

      {isAdmin && (
        <div>
          <h3 className="text-lg font-semibold mb-3">Panneau Admin</h3>

          <div className="mb-4">
            <label className="block text-sm text-gray-400">Rechercher une piste</label>
            <div className="flex gap-2 mt-2">
              <input
                value={search}
                onChange={(e) => setSearch(e.target.value)}
                placeholder="Titre, artiste..."
                className="flex-1 p-2 rounded bg-gray-900 border border-gray-700"
              />
              <button
                onClick={() => searchAPI(search)}
                className="px-3 py-2 rounded bg-indigo-600"
              >
                Rechercher
              </button>
            </div>
          </div>

          <div className="max-h-96 overflow-auto">
            {results.length === 0 && <div className="text-gray-400">Aucun résultat</div>}
            {results.map((r) => (
              <div key={r.id} className="flex items-center gap-3 p-2 border-b border-gray-700">
                <img src={r.image} alt="cover" className="w-12 h-12 object-cover rounded" />
                <div className="flex-1">
                  <div className="font-semibold">{r.title}</div>
                  <div className="text-sm text-gray-400">{r.artist}</div>
                </div>
                <button onClick={() => pickTrack(r)} className="px-3 py-1 rounded bg-green-600">Choisir</button>
              </div>
            ))}
          </div>

          <div className="mt-4 text-sm text-gray-300">Status: {status}</div>

          <div className="mt-6">
            <h4 className="font-semibold">Playlist actuelle (preview)</h4>
            <div className="mt-2">
              {tracks.length === 0 && <div className="text-gray-400">Aucune piste chargée</div>}
              {tracks.map((t) => (
                <div key={t.id} className="flex items-center gap-3 p-2 border-b border-gray-700">
                  <img src={t.image} alt="cover" className="w-10 h-10 object-cover rounded" />
                  <div className="flex-1">
                    <div className="font-semibold">{t.title}</div>
                    <div className="text-sm text-gray-400">{t.artist}</div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          <div className="mt-6 text-xs text-gray-500">
            <strong>Remarques :</strong>
            <ul className="list-disc ml-5">
              <li>Le code admin est vérifié côté client — NON SÉCURISÉ. Utiliser un backend pour une vraie app.</li>
              <li>Pour forcer la lecture immédiatement sur la station, faites une API serveur qui notifie le player.</li>
              <li>Respecter les droits d'auteur : fournissez des flux disposant des licences nécessaires.</li>
            </ul>
          </div>
        </div>
      )}
    </div>
  );
}
